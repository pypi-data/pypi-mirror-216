import{r as p,R as Z,j as e,u as K,o as L,H as ee,i as P,d as V,c as De,t as o,I as ve,v as G,g as q,s as C,S as Pe,B as se,z as oe,w as fe,J as we,A as Ae,n as Re,p as Te,K as Oe,q as Fe,P as xe,Q as ue,D as Ne,T as Be,E as re,G as Me,F as ze}from"./index-ad856934.js";import{D as Ie,I as $e,y as He,o as ie,r as Ge,a as ke,p as Ue,g as We,i as Ve,R as Le,X as Ce,$ as pe}from"./transition-9219299b.js";import{b as Qe,M as qe,_ as Ee}from"./dialog-f300575e.js";import{u as J,g as Ke,E as Q,i as Je,a as ne,b as je,c as h,P as Xe}from"./context-98478dbe.js";import{M as Ye,T as Ze,p as es,H as ss,P as H}from"./PlanChangePreview-7e412ed7.js";import{B as Y}from"./Banner-a3e8f213.js";import{T as me}from"./TasksOverview-3e8f8edd.js";import{v as M,M as ce,P as de}from"./disclosure-690a567d.js";import ns from"./ReportErrors-7028b0a7.js";import{I as ae}from"./Input-7dcd5857.js";import{s as ls}from"./popover-4cc4e19a.js";import{S as as}from"./SplitPane-5aded452.js";import"./editor-3fbec9d8.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-ca35cb8c.js";import"./Graph-580ca9ed.js";import"./PlusIcon-8d70e023.js";import"./pluralize-d8308851.js";let ye=p.createContext(null);ye.displayName="GroupContext";let ts=p.Fragment;function rs(s){var n;let[a,t]=p.useState(null),[c,r]=ss(),[j,d]=qe(),b=p.useMemo(()=>({switch:a,setSwitch:t,labelledby:c,describedby:j}),[a,t,c,j]),m={},w=s;return Z.createElement(d,{name:"Switch.Description"},Z.createElement(r,{name:"Switch.Label",props:{htmlFor:(n=b.switch)==null?void 0:n.id,onClick(u){a&&(u.currentTarget.tagName==="LABEL"&&u.preventDefault(),a.click(),a.focus({preventScroll:!0}))}}},Z.createElement(ye.Provider,{value:b},Ce({ourProps:m,theirProps:w,defaultTag:ts,name:"Switch.Group"}))))}let is="button";function os(s,n){let a=$e(),{id:t=`headlessui-switch-${a}`,checked:c,defaultChecked:r=!1,onChange:j,name:d,value:b,form:m,...w}=s,u=p.useContext(ye),y=p.useRef(null),E=He(y,n,u===null?null:u.setSwitch),[f,i]=Ze(c,j,r),_=ie(()=>i==null?void 0:i(!f)),D=ie(g=>{if(Ge(g.currentTarget))return g.preventDefault();g.preventDefault(),_()}),B=ie(g=>{g.key===ke.Space?(g.preventDefault(),_()):g.key===ke.Enter&&es(g.currentTarget)}),v=ie(g=>g.preventDefault()),A=p.useMemo(()=>({checked:f}),[f]),R={id:t,ref:E,role:"switch",type:ls(s,y),tabIndex:0,"aria-checked":f,"aria-labelledby":u==null?void 0:u.labelledby,"aria-describedby":u==null?void 0:u.describedby,onClick:D,onKeyUp:B,onKeyPress:v},z=Ue();return p.useEffect(()=>{var g;let U=(g=y.current)==null?void 0:g.closest("form");U&&r!==void 0&&z.addEventListener(U,"reset",()=>{i(r)})},[y,i]),Z.createElement(Z.Fragment,null,d!=null&&f&&Z.createElement(We,{features:Ve.Hidden,...Le({as:"input",type:"checkbox",hidden:!0,readOnly:!0,form:m,checked:f,name:d,value:b})}),Ce({ourProps:R,theirProps:w,slot:A,defaultTag:is,name:"Switch"}))}let cs=Ie(os),ds=rs,us=Object.assign(cs,{Group:ds,Label:Ye,Description:Qe});function ps({show:s,children:n,afterLeave:a,onClose:t=()=>{}}){return e.jsx(pe,{appear:!0,show:s,as:p.Fragment,afterLeave:a,children:e.jsxs(Ee,{as:"div",className:"relative z-[100] w-full h-full ",onClose:t,children:[e.jsx(pe.Child,{as:p.Fragment,enter:"ease-out duration-300",enterFrom:"bg-overlay opacity-0",enterTo:"bg-overlay opacity-80",leave:"ease-in duration-200",leaveFrom:"bg-overlay opacity-80",leaveTo:"bg-overlay opacity-0",children:e.jsx("div",{className:"fixed inset-0"})}),e.jsx("div",{className:"w-full h-full fixed inset-0",children:e.jsx(pe.Child,{as:p.Fragment,enter:"ease-out duration-300",enterFrom:"translate-x-[100%]",enterTo:"translate-x-0",leave:"ease-in duration-200",leaveFrom:"translate-x-0",leaveTo:"translate-x-[100%]",children:n})})]})})}function _e({report:s}){return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",s.total]}),e.jsxs("p",{children:["Succeeded: ",s.successful]}),e.jsxs("p",{children:["Failed: ",s.failures]}),e.jsxs("p",{children:["Errors: ",s.errors]}),e.jsxs("p",{children:["Dialect: ",s.dialect]})]}),e.jsx("ul",{children:s.details.map(n=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"â€”"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"inline-block mb-2",children:n.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:n.details})})]})]},n.message))})]})}function ms({setRefTasksOverview:s}){const{backfills:n,hasChanges:a,hasBackfills:t,activeBackfill:c,modified:r,added:j,removed:d,virtualUpdateDescription:b,skip_backfill:m,skip_tests:w,change_categorization:u,hasVirtualUpdate:y,testsReportErrors:E,testsReportMessages:f}=J(),i=K(x=>x.environment),_=L(x=>x.state),D=L(x=>x.action),B=p.useMemo(()=>Array.from(u.values()).reduce((x,{category:N,change:k})=>{var S;return(S=k==null?void 0:k.indirect)==null||S.forEach(T=>{var I;x[T]==null&&(x[T]=[]),(I=x[T])==null||I.push(N.value!==1)}),N.value===3&&(x[k.model_name]=[!0]),x},{}),[u]),v=p.useCallback(x=>Object.entries(x).reduce((N,[k,S])=>{const T=B[k];return(T!=null?T.every(Boolean):!1)||(N[k]=S),N},{}),[B]),A=p.useCallback(x=>x.reduce((N,k)=>{const S=k.model_name,T=k.interval,I={completed:0,total:k.batches,interval:T,view_name:k.view_name},W=B[S];return(W!=null?W.every(Boolean):!1)||(N[S]=I),N},{}),[B]),R=p.useMemo(()=>(c==null?void 0:c.tasks)!=null?v(c.tasks):A(n),[n,u,c]),z=_===C.Finished,g=[a,t,ee(R)].every(P),U=y&&P(z)||P(g)&&t&&P(m)&&V(Object.keys(R)),$=Ke({planAction:D,planState:_,hasBackfills:t,hasVirtualUpdate:y,hasNoChanges:g||De(Object.keys(R)),skip_backfill:m});return e.jsx("div",{className:"w-full h-full overflow-hidden overflow-y-auto p-4 scrollbar scrollbar--vertical",children:e.jsx("ul",{className:"w-full",children:D===o.Run?e.jsx(F.StepOptions,{className:"w-full"}):e.jsxs(e.Fragment,{children:[e.jsx(he,{headline:"Tests",description:"Report",disabled:i==null,children:D===o.Running?e.jsx(le,{hasSpinner:!0,children:"Running Tests ..."}):ve(E)&&ve(f)?e.jsx(le,{children:w?"Tests Skipped":"No Tests"}):e.jsxs(e.Fragment,{children:[E!=null&&e.jsx(Y,{variant:G.Danger,children:ee(E)&&e.jsx(_e,{report:E})}),f!=null&&e.jsx(Y,{variant:G.Success,children:ee(f)&&e.jsx("div",{children:f.message})})]})}),e.jsx(he,{headline:"Models",description:"Review Changes",disabled:i==null,children:a?e.jsxs(e.Fragment,{children:[(V(j)||V(d))&&e.jsxs("div",{className:"flex",children:[V(j)&&e.jsx(H,{className:"w-full m-2 max-h-[30vh]",headline:"Added Models",type:Q.Add,children:e.jsx(H.Default,{type:Q.Add,changes:j})}),V(d)&&e.jsx(H,{className:"w-full m-2 max-h-[30vh]",headline:"Removed Models",type:Q.Remove,children:e.jsx(H.Default,{type:Q.Remove,changes:d})})]}),Je(r)&&e.jsxs(e.Fragment,{children:[V(r==null?void 0:r.direct)&&e.jsx(H,{className:"m-2 max-h-[30vh]",headline:"Modified Directly ",type:Q.Direct,children:e.jsx(H.Direct,{changes:r.direct??[]})}),V(r.indirect)&&e.jsx(H,{className:"m-2 max-h-[30vh]",headline:"Modified Indirectly",type:Q.Indirect,children:e.jsx(H.Indirect,{changes:r.indirect??[]})}),V(r==null?void 0:r.metadata)&&e.jsx(H,{className:"m-2 max-h-[30vh]",headline:"Modified Metadata",type:Q.Metadata,children:e.jsx(H.Default,{type:Q.Metadata,changes:(r==null?void 0:r.metadata)??[]})})]})]}):D===o.Running?e.jsx(le,{hasSpinner:!0,children:"Checking Models..."}):e.jsx(le,{children:"No Changes"})}),e.jsx(he,{headline:"Backfill",description:"Progress",disabled:i==null,children:e.jsx(M,{defaultOpen:t,children:({open:x})=>e.jsxs(e.Fragment,{children:[e.jsx(le,{hasSpinner:P(x)&&(D===o.Running||D===o.Applying),children:e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("h3",{className:q(_===C.Cancelled&&"text-prose",_===C.Failed&&"text-danger-700",_===C.Finished&&"text-success-700"),children:$})}),U&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"mr-2 text-sm",children:"Details"}),e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:x?e.jsx(ce,{className:"h-6 w-6 text-primary-500"}):e.jsx(de,{className:"h-6 w-6 text-primary-500"})})]})]})}),e.jsxs(M.Panel,{className:"px-4 pb-2 text-sm",children:[t&&P(m)&&V(Object.keys(R))&&e.jsx(e.Fragment,{children:e.jsx(p.Suspense,{fallback:e.jsx(Pe,{className:"w-4 h-4 mr-2"}),children:e.jsx(me,{tasks:R,setRefTasksOverview:s,children:({total:N,completed:k,models:S,completedBatches:T,totalBatches:I})=>e.jsxs(e.Fragment,{children:[e.jsx(me.Summary,{environment:i.name,planState:_,headline:"Target Environment",completed:k,total:N,completedBatches:T,totalBatches:I,updateType:y?"Virtual":"Backfill",updatedAt:c==null?void 0:c.updated_at}),S!=null&&e.jsx(me.Details,{models:S,changes:{modified:r,added:j,removed:d},showBatches:t,showVirtualUpdate:y,showProgress:!0})]})})})}),y&&e.jsx("div",{children:e.jsx("small",{className:"text-sm",children:b})})]})]})},$)})]})})})}function le({hasSpinner:s=!1,children:n}){return e.jsx("span",{className:"mt-1 mb-4 px-4 py-2 bg-primary-10 flex w-full rounded-lg",children:e.jsxs("span",{className:"flex items-center w-full",children:[s&&e.jsx(Pe,{className:"w-4 h-4 mr-2"}),n]})})}function he({headline:s,description:n,children:a,disabled:t=!1}){return e.jsxs("li",{className:"mb-2 p-4",children:[e.jsx(hs,{className:"min-w-[25%] pr-12",headline:s,disabled:t,children:n}),!t&&a]})}function hs({disabled:s=!1,headline:n,children:a,className:t}){return e.jsxs("div",{className:q(s&&"opacity-40 cursor-not-allowed","mb-4 ",t),children:[n!=null&&e.jsx("h3",{className:"whitespace-nowrap font-bold text-lg",children:n}),a!=null&&e.jsx("small",{className:"whitespace-nowrap",children:a})]})}function fs(){const s=K(a=>a.environment),{testsReportErrors:n}=J();return e.jsxs("div",{className:"flex flex-col py-2 w-full",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("h4",{className:"text-xl pb-2 px-6",children:[e.jsx("span",{className:"font-bold",children:"Target Environment is"}),e.jsx("b",{className:"ml-2 px-2 py-1 font-sm rounded-md bg-primary-10 text-primary-500",children:s.name})]}),e.jsx("div",{className:"px-6",children:e.jsx(ns,{})})]}),e.jsxs("div",{className:"w-full h-full overflow-auto scrollbar scrollbar--vertical px-6 ",children:[s.isInitial&&s.isDefault&&e.jsx(Y,{variant:G.Warning,children:e.jsx(M,{defaultOpen:!0,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Y.Headline,{className:"w-full mr-2 text-sm mb-0",children:"Initializing Prod Environment"}),e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(ce,{className:"h-6 w-6 text-warning-500"}):e.jsx(de,{className:"h-6 w-6 text-warning-500"})})]}),e.jsx(M.Panel,{className:"px-4 pb-2 text-sm mt-2",children:e.jsx(Y.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})}),n!=null&&ee(n)&&e.jsx(Y,{variant:G.Danger,children:e.jsx(M,{defaultOpen:!1,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"w-full mr-2 text-sm",children:n==null?void 0:n.title}),e.jsx(M.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(ce,{className:"h-6 w-6 text-danger-500"}):e.jsx(de,{className:"h-6 w-6 text-danger-500"})})]}),e.jsx(M.Panel,{className:"px-4 pb-2 text-sm",children:e.jsx(_e,{report:n})})]})})})]})]})}function xs(s=0){return p.useCallback(n=>{setTimeout(()=>{n==null||n.focus()},s)},[s])}function js({planAction:s,disabled:n,run:a,apply:t,cancel:c,close:r,reset:j}){const{start:d,end:b,hasBackfills:m,skip_tests:w,auto_apply:u,skip_backfill:y,no_gaps:E,no_auto_categorization:f,forward_only:i,restate_models:_,hasVirtualUpdate:D}=J(),B=K(O=>O.environment),v=xs(),A=s===o.None,R=s===o.Run,z=s===o.Done,g=s===o.Cancelling,U=s===o.Apply,$=s===o.Applying,x=s===o.Running,N=x||$||g;function k(O){O.stopPropagation(),r()}function S(O){O.stopPropagation(),j()}function T(O){O.stopPropagation(),c()}function I(O){O.stopPropagation(),t()}function W(O){O.stopPropagation(),a()}const te=m&&P(y);return e.jsxs("div",{className:"flex justify-between px-4 py-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[(R||x)&&e.jsxs(se,{disabled:x||n,onClick:W,autoFocus:!0,ref:v,variant:G.Primary,children:[e.jsx("span",{children:ne(s,[o.Running,o.Run])}),w&&e.jsx("span",{className:"inline-block ml-1",children:"And Skip Test"}),u&&e.jsx("span",{className:"inline-block ml-1",children:"And Auto Apply"})]}),(U||$)&&e.jsx(se,{onClick:I,disabled:$||n,ref:v,variant:G.Primary,children:ne(s,[o.Applying],te?"Apply And Backfill":D?"Apply Virtual Update":"Apply")}),N&&e.jsx(se,{onClick:T,variant:G.Danger,className:"justify-self-end",disabled:g||n,children:ne(s,[o.Cancelling],"Cancel")}),(R||x||U||$)&&e.jsxs("p",{className:"ml-2 text-xs max-w-sm",children:[e.jsx("span",{children:"Plan for"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:B.name}),e.jsx("span",{className:"inline-block mr-1",children:"environment"}),e.jsxs("span",{className:"inline-block mr-1",children:["from"," ",e.jsx("b",{children:P(oe(d))?d:"the begining of history"})]}),e.jsxs("span",{className:"inline-block mr-1",children:["till ",e.jsx("b",{children:P(oe(d))?b:"today"})]}),E&&e.jsxs("span",{className:"inline-block mr-1",children:["with ",e.jsx("b",{children:"No Gaps"})]}),y&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Backfills"})]}),i&&e.jsxs("span",{className:"inline-block mr-1",children:["consider as a ",e.jsx("b",{children:"Breaking Change"})]}),f&&e.jsxs("span",{className:"inline-block mr-1",children:["also set ",e.jsx("b",{children:"Change Category"})," manually"]}),P(oe(_))&&e.jsxs("span",{className:"inline-block mr-1",children:["and restate folowing models ",e.jsx("b",{children:_})]})]})]}),e.jsxs("div",{className:"flex items-center",children:[(A||[N,R,n,B.isInitial&&B.isDefault,z].every(P))&&e.jsx(se,{onClick:S,variant:G.Neutral,disabled:fe([o.Resetting,o.Running,o.Applying,o.Cancelling],s)||n,children:ne(s,[o.Resetting],"Start Over")}),e.jsx(se,{onClick:k,variant:z?G.Primary:G.Neutral,disabled:fe([o.Running,o.Resetting,o.Cancelling],s)||n,ref:z||$?v:void 0,children:ne(s,[o.Done],"Close")})]})]})}function ys({enabled:s,setEnabled:n,a11yTitle:a,className:t,disabled:c=!1}){return e.jsxs(us,{checked:c?!1:s,onChange:n,className:q("relative inline-flex h-8 w-16 shrink-0 rounded-full border-2 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-4 ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","border-secondary-30",s?"bg-secondary-500":"bg-secondary-10",t,c?"opacity-50 cursor-not-allowed":"cursor-pointer"),disabled:c,children:[e.jsx("span",{className:"sr-only",children:a}),e.jsx("span",{"aria-hidden":"true",className:q("pointer-events-none inline-block h-6 w-6 transform rounded-full shadow-md  transition duration-200 ease-in-out","bg-light translate-y-[0.125rem]",s?"translate-x-8 shadow-primary-800":"translate-x-1 shadow-neutral-300 dark:shadow-neutral-600")})]})}function X({label:s,info:n,enabled:a,disabled:t=!1,setEnabled:c}){return e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[s,e.jsx("small",{className:"block text-xs text-neutral-500",children:n})]}),e.jsx(ys,{disabled:t,className:"mt-2",enabled:a,setEnabled:c})]})}function gs({className:s}){const n=je(),{skip_tests:a,no_gaps:t,skip_backfill:c,forward_only:r,auto_apply:j,no_auto_categorization:d,restate_models:b,isInitialPlanRun:m,create_from:w}=J(),u=K(f=>f.environment),y=K(f=>f.environments),E=we.getOnlySynchronized(Array.from(y));return e.jsx("li",{className:q("mt-6 mb-6",s),children:e.jsxs("form",{className:"w-full h-full",children:[e.jsxs("fieldset",{className:q("mb-10 mt-6"),children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1 px-4",children:"Set Dates"}),e.jsx("div",{className:"mt-3",children:e.jsx(F.BackfillDates,{})})]}),e.jsx("fieldset",{className:q("mb-4 mt-6"),children:e.jsx(M,{children:({open:f})=>e.jsxs(e.Fragment,{children:[e.jsxs(M.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 hover:bg-theme-darker dark:hover:bg-theme-lighter",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Additional Options"}),f?e.jsx(ce,{className:"h-6 w-6 text-primary-500"}):e.jsx(de,{className:"h-6 w-6 text-primary-500"})]}),e.jsxs(M.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:[e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[P(u.isDefault)&&e.jsxs("div",{className:"inline-block m-1 w-full",children:[e.jsx(ae.Label,{children:"Create From Environment"}),e.jsx("select",{className:q("w-full bg-neutral-100 border-2 rounded-lg py-2 px-3 text-base leading-4",E.length<2&&"opacity-50 cursor-not-allowed","flex w-full text-prose-lighter bg-theme-lighter border-theme-darker dark:border-theme-lighter dark:text-prose-darker rounded-md","border-2 focus:ring-4 focus:outline-none focus:border-secondary-500","ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100"),onChange:i=>{n({type:h.PlanOptions,create_from:i.target.value})},disabled:E.length<2,value:w,children:we.getOnlySynchronized(Array.from(y)).map(i=>e.jsx("option",{value:i.name,children:i.name},i.name))}),e.jsx(ae.Info,{children:"The environment to base the plan on rather than local files"})]}),e.jsx(ae,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
              downstream from the one specified. For production
              environment, all related model versions will have
              their intervals wiped, but only the current
              versions will be backfilled. For development
              environment, only the current model versions will
              be affected`,placeholder:"project.model1, project.model2",disabled:m,value:b??"",onInput:i=>{i.stopPropagation(),n({type:h.PlanOptions,restate_models:i.target.value})}})]})}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap w-full mt-3",children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
                  are defined`,enabled:!!a,setEnabled:i=>{n({type:h.PlanOptions,skip_tests:i})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
                  comparing to existing snapshots for matching
                  models in the target environment`,enabled:!!t,disabled:m,setEnabled:i=>{n({type:h.PlanOptions,no_gaps:i})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Skip Backfill",info:"Skip the backfill step",enabled:!!c,disabled:m,setEnabled:i=>{n({type:h.PlanOptions,skip_backfill:i})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:!!r,disabled:m,setEnabled:i=>{n({type:h.PlanOptions,forward_only:i})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:!!j,setEnabled:i=>{n({type:h.PlanOptions,auto_apply:i})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"No Auto Categorization",info:"Set category manually",enabled:!!d,disabled:m,setEnabled:i=>{n({type:h.PlanOptions,no_auto_categorization:i})}})})]})]})]})]})})})]})})}function bs({disabled:s=!1}){const n=je(),{start:a,end:t,isInitialPlanRun:c}=J();return e.jsxs("div",{className:"flex w-full flex-wrap md:flex-nowrap",children:[e.jsx(ae,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",placeholder:"2023-12-13",disabled:s||c,value:a,onInput:r=>{r.stopPropagation(),n({type:h.DateStart,start:r.target.value})}}),e.jsx(ae,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",placeholder:"2022-12-13",value:t,disabled:s||c,onInput:r=>{r.stopPropagation(),n({type:h.DateEnd,end:r.target.value})}})]})}function vs({environment:s,isInitialPlanRun:n}){const{start:a,end:t,skip_tests:c,no_gaps:r,skip_backfill:j,forward_only:d,no_auto_categorization:b,restate_models:m,create_from:w}=J(),u=p.useMemo(()=>{if(!s.isDefault)return{start:a,end:n&&oe(m)?void 0:t}},[s,a,t,n,m]);return{planOptions:p.useMemo(()=>s.isDefault||s.isInitial?{skip_tests:c}:{no_gaps:r,skip_backfill:j,forward_only:d,create_from:w,no_auto_categorization:b,skip_tests:c,restate_models:m},[s,r,j,d,w,b,c,m]),planDates:u}}function ws({isInitialPlanRun:s}){const{start:n,end:a,skip_tests:t,no_gaps:c,skip_backfill:r,forward_only:j,no_auto_categorization:d,restate_models:b,hasBackfills:m,create_from:w,change_categorization:u}=J(),y=p.useMemo(()=>{if(!(s||P(m)))return{start:n,end:a}},[m,n,a,s]),E=p.useMemo(()=>Array.from(u.values()).reduce((f,{category:i,change:_})=>(f[_.model_name]=i.value,f),{}),[u]);return{planDates:y,planOptions:{no_gaps:c,skip_backfill:r,forward_only:j,create_from:w,no_auto_categorization:d,skip_tests:t,restate_models:b},categories:E}}function F({environment:s,isInitialPlanRun:n,initialStartDate:a,initialEndDate:t,disabled:c,onClose:r}){const j=Ae(),d=je(),{errors:b,removeError:m}=Re(),{auto_apply:w,hasChanges:u,hasBackfills:y,hasVirtualUpdate:E,testsReportErrors:f}=J(),i=L(l=>l.state),_=L(l=>l.action),D=L(l=>l.activePlan),B=L(l=>l.setActivePlan),v=L(l=>l.setAction),A=L(l=>l.setState),R=p.useRef(null),[z,g]=p.useState(!1),U=Be(),$=vs({environment:s,isInitialPlanRun:n}),x=ws({isInitialPlanRun:n}),{refetch:N}=Te(s.name,$),{refetch:k}=Oe(s.name,x),S=p.useCallback(Fe(N,1e3,!0),[N]);p.useEffect(()=>{const l=U("tests",T);return s.isInitial&&s.isDefault&&be(),d([{type:h.Dates,start:a,end:t}]),()=>{S.cancel(),l==null||l()}},[]),p.useEffect(()=>{d([{type:h.External,isInitialPlanRun:n}]),n&&d([{type:h.PlanOptions,skip_backfill:!1,forward_only:!1,no_auto_categorization:!1,no_gaps:!1}])},[n]),p.useEffect(()=>{P(z)&&s.isInitial||fe([C.Running,C.Applying,C.Cancelling],i)||(P(z)?v(o.Run):P(u||y)&&P(E)||i===C.Finished?v(o.Done):i===C.Failed?v(o.None):v(o.Apply))},[i,z,u,y,E]),p.useEffect(()=>{D!=null&&d({type:h.BackfillProgress,activeBackfill:D})},[D]),p.useEffect(()=>{b.size!==0&&(B(void 0),A(C.Failed))},[b]);function T(l){d([xe(l.ok)?{type:h.TestsReportMessages,testsReportMessages:l}:{type:h.TestsReportErrors,testsReportErrors:l}])}function I(){g(!1),d([{type:h.ResetBackfills},{type:h.ResetChanges},{type:h.Dates,start:a,end:t},{type:h.ResetPlanOptions}])}function W(){v(o.Resetting),m(re.General),I(),A(C.Init),v(o.Run)}function te(){m(re.General),m(re.RunPlan),m(re.ApplyPlan),r()}function O(){d([{type:h.ResetTestsReport}]),A(C.Cancelling),v(o.Cancelling),Me(j).then(()=>{v(o.Run),A(C.Cancelled)}).catch(l=>{ue(l)?console.log("apiCancelPlanApply","Request aborted by React Query"):(console.log("apiCancelPlanApply",l),W())})}function ge(){v(o.Applying),A(C.Applying),d([{type:h.ResetTestsReport}]),k({throwOnError:!0}).then(({data:l})=>{(l==null?void 0:l.type)===ze.Virtual&&A(C.Finished)}).catch(l=>{ue(l)?console.log("planApply","Request aborted by React Query"):(console.log("planApply",l),W())}).finally(()=>{var l;(l=R==null?void 0:R.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})})}function be(){d([{type:h.ResetTestsReport}]),v(o.Running),A(C.Running),S({throwOnError:!0}).then(({data:l})=>{d([{type:h.Backfills,backfills:l==null?void 0:l.backfills},{type:h.Changes,...l==null?void 0:l.changes},{type:h.Dates,start:l==null?void 0:l.start,end:l==null?void 0:l.end}]),g(!0),A(C.Init),w?ge():v(o.Run)}).catch(l=>{ue(l)?console.log("planRun","Request aborted by React Query"):(console.log("planRun",l),W())})}const Se=ee(f);return e.jsxs("div",{className:"flex flex-col w-full h-full overflow-hidden pt-6",children:[Se?e.jsxs(as,{sizes:ee(f)?[50,50]:[30,70],direction:"vertical",snapOffset:0,className:"flex flex-col w-full h-full overflow-hidden",children:[e.jsx(F.Header,{}),e.jsx(F.Wizard,{setRefTasksOverview:R})]}):e.jsxs(e.Fragment,{children:[e.jsx(F.Header,{}),e.jsx(Ne,{}),e.jsx(F.Wizard,{setRefTasksOverview:R})]}),e.jsx(Ne,{}),e.jsx(F.Actions,{disabled:c,planAction:_,apply:ge,run:be,cancel:O,close:te,reset:W})]})}F.Actions=js;F.Header=fs;F.Wizard=ms;F.StepOptions=gs;F.BackfillDates=bs;const Hs=p.memo(function(){const{isPlanOpen:n,setIsPlanOpen:a}=Re(),t=K(u=>u.environment),c=K(u=>u.initialStartDate),r=K(u=>u.initialEndDate),j=L(u=>u.setAction),[d,b]=p.useState(!1);function m(){b(!0)}const w=xe(n)&&P(d);return e.jsx(ps,{show:w,afterLeave:()=>{j(o.None),b(!1),a(!1)},children:e.jsx(Ee.Panel,{className:"bg-theme border-8 border-r-0 border-secondary-10 dark:border-primary-10 absolute w-[90%] md:w-[75%] xl:w-[60%] h-full right-0 flex flex-col",children:e.jsx(Xe,{children:e.jsx(F,{environment:t,isInitialPlanRun:(t==null?void 0:t.isDefault)==null||xe(t==null?void 0:t.isDefault),disabled:d,initialStartDate:c,initialEndDate:r,onClose:m})})})})});export{Hs as default};
