"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,l)=>{l.r(t),l.d(t,{default:()=>I});var n=l(324),i=l(416),s=l(899),o=l(761),c=l.n(o);const d="waiting-cell",a="ready-cell",r="ready-making-cell",u="ready-making-input-cell",m="linked-waiting",C="linked-ready-maker",y=new Event("cleanup"),v={};function g(e){delete v[e]}const x={id:"jupyterlab-ipyflow",requires:[s.INotebookTracker,n.ICommandPalette],autoStart:!0,activate:(e,t,l)=>{e.commands.addCommand("alt-mode-execute",{label:"Alt Mode Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{var l,n;const s=t.currentWidget.sessionContext;if(!s.isReady)return;const o=null!==(l=v[s.session.id])&&void 0!==l?l:{};null!==(n=o.isIpyflowCommConnected)&&void 0!==n&&n?"code"===t.activeCell.model.type&&(e.commands.execute("notebook:enter-command-mode"),o.isAltModeExecuting?s.session.kernel.requestExecute({code:"%flow toggle-reactivity-until-next-reset",silent:!0,store_history:!1}).done.then((()=>{s.session.kernel.requestExecute({code:"%flow toggle-reactivity-until-next-reset",silent:!0,store_history:!1}).done.then((()=>{i.CodeCell.execute(t.activeCell,s)}))})):(o.isAltModeExecuting=!0,s.session.kernel.requestExecute({code:"%flow toggle-reactivity-until-next-reset",silent:!0,store_history:!1}).done.then((()=>{i.CodeCell.execute(t.activeCell,s)})))):(e.commands.execute("notebook:enter-command-mode"),i.CodeCell.execute(t.activeCell,s))}}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Accel Shift Enter"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Ctrl Shift Enter"],selector:".jp-Notebook"}),l.addItem({command:"alt-mode-execute",category:"execution",args:{}}),e.commands.addCommand("alt-execute",{label:"Alt Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{const l=t.currentWidget.sessionContext;l.isReady&&(e.commands.execute("notebook:enter-command-mode"),i.CodeCell.execute(t.activeCell,l))}}),e.commands.addKeyBinding({command:"alt-execute",keys:["Accel Enter"],selector:".jp-Notebook"}),t.widgetAdded.connect(((e,t)=>{const l=t.sessionContext;let n=()=>g(l.session.id);const i=()=>{l.session.kernel.registerCommTarget("ipyflow-client",((e,i)=>{e.onMsg=e=>{var i;const s=e.content.data;(null===(i=s.success)||void 0===i||i)&&("unestablish"===s.type?n():"establish"===s.type&&(n(),n=L(l,t.content)))},n(),n=L(l,t.content)}))};l.ready.then((()=>{_(t.content),i(),n(),n=L(l,t.content),l.kernelChanged.connect(((e,s)=>{null!=s.newValue&&(_(t.content),n(),g(l.session.id),n=()=>g(l.session.id),l.ready.then((()=>{i(),n=L(l,t.content)})))}))}))}))}},f=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},h=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},w=(e,t,l)=>{const n=()=>{e.removeEventListener(t,l),e.removeEventListener("cleanup",n)};e.addEventListener(t,l),e.addEventListener("cleanup",n)},E=(e,t,l,n,i)=>{null!==e&&null!==t&&w(e,l,(()=>{t.firstElementChild.classList[n](i)}))},p=(e,t)=>{E(f(e),h(e),"mouseover","add",m),E(f(e),h(e),"mouseout","remove",m),E(h(e),f(e),"mouseover","add",t),E(h(e),f(e),"mouseout","remove",t)},_=e=>{e.widgets.forEach((e=>{e.node.classList.remove(d),e.node.classList.remove(r),e.node.classList.remove(a),e.node.classList.remove(u);const t=f(e.node);null!==t&&(t.firstElementChild.classList.remove(m),t.firstElementChild.classList.remove(C),t.dispatchEvent(y));const l=h(e.node);null!==l&&(l.firstElementChild.classList.remove(m),l.firstElementChild.classList.remove(C),l.dispatchEvent(y))}))},k=(e,t,l,n,i,s,o)=>{if(null===e)return;const c=()=>{for(const e of t){let t=C;o.has(e)&&(t=m);const i=n(l[e]);if(null===i||null===i.firstElementChild)return;i.firstElementChild.classList[s](t)}};e.addEventListener(i,c),w(e,i,c)},L=(e,t)=>{var l;l=e.session.id,v[l]={isIpyflowCommConnected:!1,dirtyCells:new Set,waitingCells:new Set,readyCells:new Set,waiterLinks:{},readyMakerLinks:{},activeCell:null,activeCellId:null,cellsById:{},cellModelsById:{},orderIdxById:{},cellPendingExecution:null,lastExecutionMode:null,isReactivelyExecuting:!1,isAltModeExecuting:!1,lastExecutionHighlights:null,executedReactiveReadyCells:new Set,newReadyCells:new Set,forcedReactiveCells:new Set};const n=v[e.session.id];n.activeCell=t.activeCell,n.activeCellId=n.activeCell.model.id;const s=e.session.kernel.createComm("ipyflow","ipyflow");let o=!1;const y=()=>{const e={};return t.widgets.forEach(((t,l)=>{const n=t.model;e[n.id]={index:l,content:n.sharedModel.getSource(),type:n.type}})),e},x=c().debounce((()=>{o?t.model.contentChanged.disconnect(x):s.send({type:"notify_content_changed",cell_metadata_by_id:y()})}),500),w=e=>{const t=y();s.send({type:"compute_exec_schedule",executed_cell_id:null==e?void 0:e.id,cell_metadata_by_id:t,is_reactively_executing:n.isReactivelyExecuting})},E=(e,l)=>{o?e.stateChanged.disconnect(E):"executionCount"===l.name&&null!==l.newValue&&(t.widgets.forEach((t=>{t.model.id===e.id&&(t.node.classList.remove(a),t.node.classList.remove(u))})),w(e))},L=e=>{let l=-1;t.widgets.forEach(((t,n)=>{t.model.id===e.id&&(l=n)}));const n={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:l};s.send(n)},I=e=>{n.cellsById={},n.cellModelsById={},n.orderIdxById={},e.widgets.forEach(((e,t)=>{n.cellsById[e.model.id]=e.node,n.cellModelsById[e.model.id]=e.model,n.orderIdxById[e.model.id]=t}))},b=(e,l)=>{if(t===e)if(o)t.activeCellChanged.disconnect(b);else if(L(l.model),null!==n.activeCell&&null!==n.activeCell.model&&(n.activeCell.model.isDirty?n.dirtyCells.add(n.activeCellId):n.dirtyCells.delete(n.activeCellId),n.activeCell.model.stateChanged.disconnect(E,n.activeCell.model.stateChanged)),n.activeCell=l,n.activeCellId=l.model.id,null!==n.activeCell&&null!==n.activeCell.model&&"code"===n.activeCell.model.type){if(n.activeCell.model.stateChanged.connect(E),L(n.activeCell.model),n.dirtyCells.has(n.activeCellId)){const e=n.activeCell.model;void 0!==e._setDirty&&e._setDirty(!0)}I(t),M(n.activeCellId)}},R=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],M=e=>{const t=n.cellModelsById[e];if("code"!==t.type)return;if(null==t.executionCount)return;const l=n.cellsById[e];n.waitingCells.has(e)?(l.classList.add(d),l.classList.add(a),l.classList.remove(u),p(l,m)):n.readyCells.has(e)&&(l.classList.add(u),l.classList.add(a),p(l,C)),"reactive"!==n.lastExecutionMode&&(Object.prototype.hasOwnProperty.call(n.waiterLinks,e)&&R.forEach((({action:t,update:i})=>{k(f(l),n.waiterLinks[e],n.cellsById,f,t,i,n.waitingCells),k(h(l),n.waiterLinks[e],n.cellsById,f,t,i,n.waitingCells)})),Object.prototype.hasOwnProperty.call(n.readyMakerLinks,e)&&(n.waitingCells.has(e)||(l.classList.add(r),l.classList.add(a)),R.forEach((({action:t,update:i})=>{k(f(l),n.readyMakerLinks[e],n.cellsById,f,t,i,n.waitingCells),k(f(l),n.readyMakerLinks[e],n.cellsById,h,t,i,n.waitingCells)}))))};return s.onMsg=l=>{var c,d;const a=l.content.data;if(!o&&(null===(c=a.success)||void 0===c||c))if("establish"===a.type)n.isIpyflowCommConnected=!0,t.activeCellChanged.connect(b),t.activeCell.model.stateChanged.connect(E),L(t.activeCell.model),t.model.contentChanged.connect(x),w();else if("set_exec_mode"===a.type)n.isAltModeExecuting=!1,n.lastExecutionMode=a.exec_mode;else if("compute_exec_schedule"===a.type){n.waitingCells=new Set(a.waiting_cells),n.readyCells=new Set(a.ready_cells),n.newReadyCells=new Set([...n.newReadyCells,...a.new_ready_cells]),n.forcedReactiveCells=new Set([...n.forcedReactiveCells,...a.forced_reactive_cells]),n.waiterLinks=a.waiter_links,n.readyMakerLinks=a.ready_maker_links,n.cellPendingExecution=null;const l=a.exec_mode;n.isReactivelyExecuting=n.isReactivelyExecuting||null!==(d=null==a?void 0:a.is_reactively_executing)&&void 0!==d&&d;const o=a.flow_order,c=a.exec_schedule;n.lastExecutionMode=l,n.lastExecutionHighlights=a.highlights;const r=a.last_executed_cell_id;if(n.executedReactiveReadyCells.add(r),!a.last_execution_was_error){let e=!1;for(const i of t.widgets){if(!e&&(e=i.model.id===r,"in_order"===o||"strict"===c))continue;if("code"!==i.model.type||n.executedReactiveReadyCells.has(i.model.id))continue;if(!n.newReadyCells.has(i.model.id))continue;if(!n.forcedReactiveCells.has(i.model.id)&&"reactive"!==l)continue;const t=i;if(null===n.cellPendingExecution){if(n.cellPendingExecution=t,"in_order"===o||"strict"===c)break}else null==t.model.executionCount||t.model.executionCount<n.cellPendingExecution.model.executionCount&&(n.cellPendingExecution=t)}}null===n.cellPendingExecution?(n.isReactivelyExecuting&&("reactive"===n.lastExecutionHighlights&&(n.readyCells=n.executedReactiveReadyCells),s.send({type:"reactivity_cleanup"})),n.forcedReactiveCells=new Set,n.newReadyCells=new Set,n.executedReactiveReadyCells=new Set,(e=>{if(_(e),"none"!==n.lastExecutionHighlights){I(e);for(const[e]of Object.entries(n.cellsById))M(e)}})(t),n.isReactivelyExecuting=!1,"reactive"===n.lastExecutionMode&&(n.isAltModeExecuting=!1)):(n.isReactivelyExecuting=!0,b(t,n.cellPendingExecution),i.CodeCell.execute(n.cellPendingExecution,e))}},s.open({interface:"jupyterlab"}),()=>{s.dispose(),o=!0,n.isIpyflowCommConnected=!1,g(e.session.id)}},I=x}}]);