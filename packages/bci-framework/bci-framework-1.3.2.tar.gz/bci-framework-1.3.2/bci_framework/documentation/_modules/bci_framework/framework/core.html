
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bci_framework.framework.core &#8212; BCI-Framework  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/favico.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bci_framework.framework.core</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
====
Core
====
&quot;&quot;&quot;

import os
import sys
import time
import json
import psutil
import pickle
import platform
import subprocess
from datetime import datetime
from typing import TypeVar, Optional

from PySide6.QtUiTools import QUiLoader
from PySide6.QtCore import Qt, QTimer, QSize, Signal, QThread, Slot
from PySide6.QtGui import (
    QPixmap,
    QIcon,
    QFontDatabase,
    QKeySequence,
    QShortcut,
)
from PySide6.QtWidgets import (
    QWidget,
    QMainWindow,
    QPushButton,
    QLabel,
    QCheckBox,
)

from kafka import KafkaProducer, KafkaConsumer
import ntplib

from .widgets import Montage, Projects, Connection, Records, Annotations
from .environments import (
    Development,
    Visualization,
    StimuliDelivery,
    TimeLockAnalysis,
)
from .config_manager import ConfigManager
from .configuration import ConfigurationFrame
from .subprocess_handler import run_subprocess
from .raspad import Raspad

KafkaMessage = TypeVar(&#39;KafkaMessage&#39;)
PathLike = TypeVar(&#39;PathLike&#39;)
HostLike = TypeVar(&#39;HostLike&#39;)
Millis = TypeVar(&#39;Milliseconds&#39;)


########################################################################
<div class="viewcode-block" id="ClockOffset"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.ClockOffset">[docs]</a>class ClockOffset(QThread):
    &quot;&quot;&quot;&quot;&quot;&quot;

    signal_offset = Signal(object)

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="ClockOffset.set_host"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.ClockOffset.set_host">[docs]</a>    def set_host(self, host: HostLike) -&gt; None:
        &quot;&quot;&quot;Set the host for kafka.&quot;&quot;&quot;
        self.host = host</div>

    # ----------------------------------------------------------------------
    def run(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        try:
            client = ntplib.NTPClient()
            r = client.request(self.host)
            clock_offset = r.offset  # * 1000
            self.signal_offset.emit(clock_offset)
            print(f&#39;offset: {clock_offset}&#39;)
        except Exception:
            pass</div>


########################################################################
<div class="viewcode-block" id="Kafka"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka">[docs]</a>class Kafka(QThread):
    &quot;&quot;&quot;Kafka run on a thread.&quot;&quot;&quot;

    signal_kafka_message = Signal(object)
    signal_exception_message = Signal()
    signal_produser = Signal()
    keep_alive = True

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.set_host"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.set_host">[docs]</a>    def set_host(self, host: HostLike) -&gt; None:
        &quot;&quot;&quot;Set the host for kafka.&quot;&quot;&quot;
        self.host = host</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.stop"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.stop">[docs]</a>    def stop(self) -&gt; None:
        &quot;&quot;&quot;Kill the thread.&quot;&quot;&quot;
        self.keep_alive = False
        self.terminate()</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.run"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.run">[docs]</a>    def run(self) -&gt; None:
        &quot;&quot;&quot;Start the produser and consumer for Kafka.&quot;&quot;&quot;
        try:
            self.create_produser()
            self.signal_produser.emit()
            self.consumed = False
            self.create_consumer()
        except Exception:
            self.signal_exception_message.emit()
            self.stop()</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.create_consumer"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.create_consumer">[docs]</a>    def create_consumer(self) -&gt; None:
        &quot;&quot;&quot;Basic consumer to check stream status and availability.&quot;&quot;&quot;
        bootstrap_servers = [f&#39;{self.host}:9092&#39;]
        topics = [
            &#39;annotation&#39;,
            &#39;marker&#39;,
            &#39;command&#39;,
            &#39;eeg&#39;,
            &#39;aux&#39;,
            &#39;feedback&#39;,
        ]
        self.consumer = KafkaConsumer(
            bootstrap_servers=bootstrap_servers,
            value_deserializer=pickle.loads,
            auto_offset_reset=&#39;latest&#39;,
        )

        self.consumer.subscribe(topics)
        for message in self.consumer:
            self.last_message = datetime.now()
            message.value[&#39;timestamp&#39;] = message.timestamp / 1000

            self.signal_kafka_message.emit(
                {&#39;topic&#39;: message.topic, &#39;value&#39;: message.value}
            )

            if not self.keep_alive:
                return</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="Kafka.create_produser"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.Kafka.create_produser">[docs]</a>    def create_produser(self) -&gt; None:
        &quot;&quot;&quot;The produser is used for stream annotations and markers.&quot;&quot;&quot;
        self.produser = KafkaProducer(
            bootstrap_servers=[f&#39;{self.host}:9092&#39;],
            compression_type=&#39;gzip&#39;,
            value_serializer=pickle.dumps,
        )</div></div>


########################################################################
<div class="viewcode-block" id="BCIFramework"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework">[docs]</a>class BCIFramework(QMainWindow):
    &quot;&quot;&quot;&quot;&quot;&quot;

    # ----------------------------------------------------------------------
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        self.load_fonts()
        self.main = QUiLoader().load(
            os.path.join(
                os.path.abspath(os.path.dirname(__file__)),
                &#39;qtgui&#39;,
                &#39;main.ui&#39;,
            )
        )
        self.set_icons()

        self.main.setCorner(Qt.BottomLeftCorner, Qt.LeftDockWidgetArea)
        self.main.setCorner(Qt.BottomRightCorner, Qt.RightDockWidgetArea)

        self.main.actionDevelopment.triggered.connect(
            lambda evt: self.show_interface(&#39;Development&#39;)
        )
        self.main.actionVisualizations.triggered.connect(
            lambda evt: self.show_interface(&#39;Visualizations&#39;)
        )
        self.main.actionStimuli_delivery.triggered.connect(
            lambda evt: self.show_interface(&#39;Stimuli_delivery&#39;)
        )
        self.main.actionTimelock_analysis.triggered.connect(
            lambda evt: self.show_interface(&#39;Timelock_analysis&#39;)
        )
        self.main.actionHome.triggered.connect(
            lambda evt: self.show_interface(&#39;Home&#39;)
        )
        self.main.actionDocumentation.triggered.connect(
            lambda evt: self.show_interface(&#39;Documentation&#39;)
        )
        self.main.actionRaspad_settings.triggered.connect(
            lambda evt: self.show_interface(&#39;Raspad_settings&#39;)
        )

        self.main.stackedWidget_montage.setCurrentWidget(
            self.main.page_montage
        )

        self.show_interface(&#39;Home&#39;)
        self.config = ConfigManager()

        for i in range(self.main.toolBar_Environs.layout().count()):
            tool_button = (
                self.main.toolBar_Environs.layout().itemAt(i).widget()
            )
            tool_button.setMaximumWidth(200)
            tool_button.setMinimumWidth(200)

        self.set_editor()
        self.build_collapse_button()

        self.montage = Montage(self)
        self.connection = Connection(self)
        self.projects = Projects(self.main, self)
        self.records = Records(self.main, self)
        self.annotations = Annotations(self.main, self)
        self.raspad = Raspad(self)

        self.development = Development(self)
        self.visualizations = Visualization(self)
        self.stimuli_delivery = StimuliDelivery(self)
        self.timelock_analysis = TimeLockAnalysis(self)

        # self.status_bar(&#39;OpenBCI no connected&#39;)

        self.main.tabWidget_widgets.setCurrentIndex(0)
        self.main.tabWidget_data_analysis.setCurrentIndex(0)
        self.main.tabWidget_stimuli_delivery.setCurrentIndex(0)
        self.main.stackedWidget_noneeg.setCurrentIndex(0)
        self.style_home_page()

        self.connect()

        docs = os.path.abspath(
            os.path.join(
                os.environ.get(&#39;BCISTREAM_ROOT&#39;),
                &#39;documentation&#39;,
                &#39;index.html&#39;,
            )
        )
        self.main.webEngineView_documentation.setUrl(f&#39;file://{docs}&#39;)

        self.subprocess_timer = QTimer()
        self.subprocess_timer.timeout.connect(self.save_subprocess)
        self.subprocess_timer.setInterval(5000)
        self.subprocess_timer.start()

        self.clock_offset = 0
        self.eeg_size = 0
        self.aux_size = 0
        self.sample_rate = 0
        self.last_update = 0

        # QTimer().singleShot(1000, self.calculate_offset)
        QTimer().singleShot(3000, self.start_stimuli_server)

        self.status_bar(message=&#39;&#39;, right_message=(&#39;disconnected&#39;, None))

        shortcut_fullscreen = QShortcut(QKeySequence(&#39;F11&#39;), self.main)
        shortcut_fullscreen.activated.connect(
            lambda: self.main.showMaximized()
            if self.main.windowState() &amp; Qt.WindowFullScreen
            else self.main.showFullScreen()
        )

        shortcut_docs = QShortcut(QKeySequence(&#39;F1&#39;), self.main)
        shortcut_docs.activated.connect(
            lambda: self.show_interface(&#39;Documentation&#39;)
        )

        shortcut_docs = QShortcut(QKeySequence(&#39;F2&#39;), self.main)
        shortcut_docs.activated.connect(self.toggle_dock_collapsed)

        shortcut_docs = QShortcut(QKeySequence(&#39;F9&#39;), self.main)
        shortcut_docs.activated.connect(
            self.timelock_analysis.show_fullscreen
        )

        self.main.toolBar_Environs.setStyleSheet(
            &quot;&quot;&quot;
          * {
          min-width: 200px;
          }
          &quot;&quot;&quot;
        )

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.set_icons"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.set_icons">[docs]</a>    def set_icons(self) -&gt; None:
        &quot;&quot;&quot;The Qt resource system has been deprecated.&quot;&quot;&quot;

        def icon(name):
            return QIcon(f&quot;bci:/primary/{name}.svg&quot;)

        self.main.actionDevelopment.setIcon(icon(&quot;file&quot;))
        self.main.actionVisualizations.setIcon(icon(&quot;latency2&quot;))
        self.main.actionStimuli_delivery.setIcon(icon(&quot;imagery&quot;))
        self.main.actionTimelock_analysis.setIcon(icon(&quot;brain&quot;))
        self.main.actionHome.setIcon(icon(&quot;home&quot;))
        self.main.actionDocumentation.setIcon(icon(&quot;documentation&quot;))

        if json.loads(os.getenv(&#39;BCISTREAM_RASPAD&#39;)):
            self.main.actionRaspad_settings.setIcon(icon(&quot;brain_settings&quot;))
        else:
            self.main.actionRaspad_settings.setVisible(False)

        self.main.pushButton_file.setIcon(icon(&quot;file&quot;))
        self.main.pushButton_brain.setIcon(icon(&quot;brain&quot;))
        self.main.pushButton_imagery.setIcon(icon(&quot;imagery&quot;))
        self.main.pushButton_docs.setIcon(icon(&quot;documentation&quot;))
        self.main.pushButton_latency.setIcon(icon(&quot;latency&quot;))
        self.main.pushButton_annotations.setIcon(icon(&quot;annotation&quot;))
        self.main.pushButton_timelock.setIcon(icon(&quot;latency2&quot;))

        self.main.pushButton_stop_preview.setIcon(
            icon(&#39;media-playback-stop&#39;)
        )
        self.main.pushButton_script_preview.setIcon(
            icon(&#39;media-playback-start&#39;)
        )
        self.main.pushButton_play_signal.setIcon(
            icon(&#39;media-playback-start&#39;)
        )
        self.main.pushButton_clear_debug.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_remove_record.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_remove_annotations.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_remove_markers.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_remove_commands.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_record.setIcon(icon(&#39;media-record&#39;))

        self.main.pushButton_projects_add_file.setIcon(icon(&#39;document-new&#39;))
        self.main.pushButton_projects_add_folder.setIcon(icon(&#39;folder-add&#39;))
        self.main.pushButton_add_project.setIcon(icon(&#39;folder-add&#39;))
        self.main.pushButton_projects_remove.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_remove_project.setIcon(icon(&#39;edit-delete&#39;))
        self.main.pushButton_remove_montage.setIcon(icon(&#39;edit-delete&#39;))

        self.main.pushButton_projects.setIcon(icon(&#39;go-previous&#39;))
        self.main.pushButton_load_visualizarion.setIcon(icon(&#39;list-add&#39;))

        self.main.pushButton_open_records_folder.setIcon(icon(&#39;folder&#39;))
        self.main.pushButton_open_extension_folder.setIcon(icon(&#39;folder&#39;))
        self.main.pushButton_open_project_raspad.setIcon(icon(&#39;folder&#39;))

        for i in range(1, 5):
            getattr(self.main, f&#39;pushButton_update_wifi{i}&#39;).setIcon(
                icon(&#39;gtk-convert&#39;)
            )

        self.main.setWindowIcon(icon(&quot;logo&quot;))</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.save_subprocess"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.save_subprocess">[docs]</a>    def save_subprocess(self) -&gt; None:
        &quot;&quot;&quot;Save in a file all the child subprocess.&quot;&quot;&quot;
        current_process = psutil.Process()
        children = current_process.children(recursive=True)
        children.append(current_process)
        file = os.path.join(os.environ[&#39;BCISTREAM_HOME&#39;], &#39;.subprocess&#39;)
        try:
            with open(file, &#39;w&#39;) as file_:
                json.dump(
                    {ch.pid: ch.name() for ch in children}, file_, indent=2
                )
        except:  # psutil.NoSuchProcess: psutil.NoSuchProcess process no longer exists
            pass</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.load_fonts"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.load_fonts">[docs]</a>    def load_fonts(self) -&gt; None:
        &quot;&quot;&quot;Load custom fonts.&quot;&quot;&quot;
        fonts_path = os.path.join(
            os.environ[&#39;BCISTREAM_ROOT&#39;], &#39;assets&#39;, &#39;fonts&#39;
        )

        for font_dir in [os.path.join(&#39;dejavu&#39;, &#39;ttf&#39;)]:
            for font in filter(
                lambda s: s.endswith(&#39;.ttf&#39;),
                os.listdir(os.path.join(fonts_path, font_dir)),
            ):
                QFontDatabase.addApplicationFont(
                    os.path.join(fonts_path, font_dir, font)
                )</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.build_collapse_button"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.build_collapse_button">[docs]</a>    def build_collapse_button(self) -&gt; None:
        &quot;&quot;&quot;Custom collapsible widgets area.&quot;&quot;&quot;
        # This dockWidget has empy name so,
        # with in that space is possible to add a custom widget
        self.pushButton_collapse_dock = QPushButton(
            self.main.dockWidget_global
        )
        self.pushButton_collapse_dock.clicked.connect(
            self.set_dock_collapsed
        )

        icon = QIcon(&#39;bci:/primary/arrow-right-double.svg&#39;)
        self.pushButton_collapse_dock.setIcon(icon)
        self.pushButton_collapse_dock.setCheckable(True)
        self.pushButton_collapse_dock.setFlat(True)

        w = self.main.tabWidget_widgets.tabBar().width()
        self.pushButton_collapse_dock.setMinimumWidth(w)
        self.pushButton_collapse_dock.setMaximumWidth(w)
        self.pushButton_collapse_dock.move(5, 5)</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.set_dock_collapsed"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.set_dock_collapsed">[docs]</a>    def set_dock_collapsed(self, collapsed: bool) -&gt; None:
        &quot;&quot;&quot;Collapse widgets area.&quot;&quot;&quot;
        if collapsed:
            w = self.main.tabWidget_widgets.tabBar().width() + 10
            icon = QIcon(&#39;bci:/primary/arrow-left-double.svg&#39;)
            self.previous_width = self.main.dockWidget_global.width()
        else:
            if self.main.dockWidget_global.width() &gt; 50:
                return
            icon = QIcon(&#39;bci:/primary/arrow-right-double.svg&#39;)
            w = self.previous_width

        self.pushButton_collapse_dock.setIcon(icon)
        self.main.dockWidget_global.setMaximumWidth(w)
        self.main.dockWidget_global.setMinimumWidth(w)

        if not collapsed:
            self.main.dockWidget_global.setMaximumWidth(w * 99)
            self.main.dockWidget_global.setMinimumWidth(0)</div>

    # ----------------------------------------------------------------------
    def toggle_dock_collapsed(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        if self.main.dockWidget_global.maximumWidth() &lt; 100:
            self.set_dock_collapsed(False)
        else:
            self.set_dock_collapsed(True)

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.connect"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.connect">[docs]</a>    def connect(self) -&gt; None:
        &quot;&quot;&quot;Connect events.&quot;&quot;&quot;
        self.main.tabWidget_widgets.currentChanged.connect(
            lambda: self.set_dock_collapsed(False)
        )

        self.main.pushButton_add_project_2.clicked.connect(
            self.projects.show_create_project_dialog
        )

        self.main.pushButton_show_visualization.clicked.connect(
            lambda evt: self.show_interface(&#39;Visualizations&#39;)
        )
        self.main.pushButton_show_stimuli_delivery.clicked.connect(
            lambda evt: self.show_interface(&#39;Stimuli_delivery&#39;, 0)
        )
        self.main.pushButton_show_timelock.clicked.connect(
            lambda evt: self.show_interface(&#39;Timelock_analysis&#39;, 0)
        )

        self.main.pushButton_show_documentation.clicked.connect(
            lambda evt: self.show_interface(&#39;Documentation&#39;)
        )

        self.main.pushButton_show_about.clicked.connect(self.show_about)
        self.main.pushButton_show_configurations.clicked.connect(
            self.show_configurations
        )

        self.main.pushButton_show_latency_correction.clicked.connect(
            lambda evt: self.show_interface(&#39;Stimuli_delivery&#39;, 1)
        )

        self.main.pushButton_show_annotations.clicked.connect(
            lambda evt: self.main.tabWidget_widgets.setCurrentIndex(3)
        )

        self.main.tabWidget_widgets.currentChanged.connect(self.show_widget)

        self.main.pushButton_open_extension_folder.clicked.connect(
            lambda: self.open_folder_in_system(
                self.main.label_projects_path.text()
            )
        )
        self.main.pushButton_open_records_folder.clicked.connect(
            lambda: self.open_folder_in_system(
                self.main.label_records_path.text()
            )
        )

        self.main.checkBox_board1.toggled.connect(
            lambda checked: not checked
            and self.main.checkBox_board1.setChecked(True)
        )
        # self.main.checkBox_board1.toggled.connect(
        # lambda b: self.board_handle(self.main.checkBox_board2, b))
        self.main.checkBox_board2.toggled.connect(
            lambda b: self.board_handle(self.main.checkBox_board3, b)
        )
        self.main.checkBox_board3.toggled.connect(
            lambda b: self.board_handle(self.main.checkBox_board4, b)
        )</div>

    # ----------------------------------------------------------------------
    def board_handle(self, chbox: QCheckBox, enable: bool) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        chbox.setEnabled(enable)
        chbox.setChecked(False)

    # ----------------------------------------------------------------------
    def open_folder_in_system(self, path: PathLike) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        if platform.system() == &quot;Windows&quot;:
            os.startfile(path)
        elif platform.system() == &quot;Darwin&quot;:
            subprocess.Popen([&quot;open&quot;, path])
        else:
            subprocess.Popen([&quot;xdg-open&quot;, path])

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.show_interface"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.show_interface">[docs]</a>    def show_interface(
        self, interface: str, sub_widget: Optional[int] = None
    ) -&gt; None:
        &quot;&quot;&quot;Switch between environs.&quot;&quot;&quot;
        self.main.stackedWidget_modes.setCurrentWidget(
            getattr(self.main, f&quot;page{interface}&quot;)
        )
        for action in self.main.toolBar_Environs.actions():
            action.setChecked(False)
        for action in self.main.toolBar_Documentation.actions():
            action.setChecked(False)
        if action := getattr(self.main, f&quot;action{interface}&quot;, False):
            action.setChecked(True)

        if mod := getattr(
            self, f&#39;{interface.lower().replace(&quot; &quot;, &quot;_&quot;)}&#39;, False
        ):
            if on_focus := getattr(mod, &#39;on_focus&#39;):
                on_focus()

        if sub_widget != None:
            if interface == &#39;Stimuli_delivery&#39;:
                self.main.tabWidget_stimuli_delivery.setCurrentIndex(
                    sub_widget
                )</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.show_widget"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.show_widget">[docs]</a>    def show_widget(self, index: int) -&gt; None:
        &quot;&quot;&quot;Call `on_focus` method for all widgets.&quot;&quot;&quot;
        widget = self.main.tabWidget_widgets.tabText(index)
        if wg := getattr(self, widget.lower(), False):
            if on_focus := getattr(wg, &#39;on_focus&#39;, False):
                on_focus()</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.set_editor"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.set_editor">[docs]</a>    def set_editor(self) -&gt; None:
        &quot;&quot;&quot;Change some styles.&quot;&quot;&quot;
        self.main.plainTextEdit_preview_log.setStyleSheet(
            &quot;&quot;&quot;
        *{
        font-weight: normal;
        font-family: &#39;DejaVu Sans Mono&#39;;
        }
        &quot;&quot;&quot;
        )

        self.main.mdiArea.setStyleSheet(
            f&quot;&quot;&quot;
        *{{
        background: {os.environ.get(&#39;QTMATERIAL_SECONDARYDARKCOLOR&#39;)};
        }}
        &quot;&quot;&quot;
        )</div>

    # # ----------------------------------------------------------------------
    # def remove_widgets_from_layout(self, layout) -&gt; None:
    # &quot;&quot;&quot;&quot;&quot;&quot;
    # for i in reversed(range(layout.count())):
    # if item := layout.takeAt(i):
    # item.widget().deleteLater()

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.status_bar"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.status_bar">[docs]</a>    def status_bar(
        self,
        message: Optional[str] = None,
        right_message: Optional[str] = None,
    ) -&gt; None:
        &quot;&quot;&quot;Update messages for status bar.&quot;&quot;&quot;
        statusbar = self.main.statusBar()

        if not hasattr(statusbar, &#39;right_label&#39;):
            statusbar.right_label = QLabel(statusbar)
            statusbar.right_label.setAlignment(Qt.AlignRight)
            statusbar.right_label.mousePressEvent = (
                lambda evt: self.main.tabWidget_widgets.setCurrentWidget(
                    self.main.tab_connection
                )
            )
            statusbar.addPermanentWidget(statusbar.right_label)

            statusbar.btn = QPushButton()
            statusbar.btn.setProperty(&#39;class&#39;, &#39;connection&#39;)
            statusbar.btn.blockSignals(True)
            statusbar.addPermanentWidget(statusbar.btn)

        if message:
            statusbar.showMessage(message)

        if right_message:
            # statusbar.btn.blockSignals(False)
            message, status = right_message
            statusbar.right_label.setText(message)
            if status is None:
                statusbar.btn.setDisabled(True)
                if &#39;light&#39; in os.environ.get(&#39;QTMATERIAL_THEME&#39;):
                    statusbar.btn.setStyleSheet(
                        f&quot;&quot;&quot;*{{
                    border: 1px solid {os.environ.get(&#39;QTMATERIAL_SECONDARYDARKCOLOR&#39;)};
                    background-color: {os.environ.get(&#39;QTMATERIAL_SECONDARYDARKCOLOR&#39;)};}}&quot;&quot;&quot;
                    )
                else:
                    statusbar.btn.setStyleSheet(
                        f&quot;&quot;&quot;*{{
                    border: 1px solid {os.environ.get(&#39;QTMATERIAL_SECONDARYLIGHTCOLOR&#39;)};
                    background-color: {os.environ.get(&#39;QTMATERIAL_SECONDARYLIGHTCOLOR&#39;)};}}&quot;&quot;&quot;
                    )
            else:
                statusbar.btn.setDisabled(False)
                if status:
                    statusbar.btn.setStyleSheet(
                        &quot;&quot;&quot;*{
                      border: 1px solid #3fc55e;
                    background-color: #3fc55e;}&quot;&quot;&quot;
                    )
                else:
                    statusbar.btn.setStyleSheet(
                        &quot;&quot;&quot;*{
                      border: 1px solid #dc3545;
                    background-color: #dc3545;}&quot;&quot;&quot;
                    )</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.style_home_page"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.style_home_page">[docs]</a>    def style_home_page(self) -&gt; None:
        &quot;&quot;&quot;Set the styles for home page.&quot;&quot;&quot;

        if json.loads(os.getenv(&#39;BCISTREAM_RASPAD&#39;)):
            size = 50
            version = &#39;RASPAD&#39;
        else:
            size = 80
            version = &#39;&#39;

        if &#39;--local&#39; in sys.argv:
            mode = &#39;DEBUG&#39;
        else:
            mode = &#39;&#39;

        style = f&quot;&quot;&quot;
        *{{
        width:      {size}px;
        height:     {size}px;
        max-width:  {size}px;
        min-width:  {size}px;
        max-height: {size}px;
        min-height: {size}px;
        background-color: {os.environ.get(&#39;secondaryColor&#39;)}
        }}
        &quot;&quot;&quot;
        self.main.pushButton_file.setStyleSheet(style)
        self.main.pushButton_brain.setStyleSheet(style)
        self.main.pushButton_imagery.setStyleSheet(style)
        self.main.pushButton_docs.setStyleSheet(style)
        self.main.pushButton_latency.setStyleSheet(style)
        self.main.pushButton_annotations.setStyleSheet(style)
        self.main.pushButton_timelock.setStyleSheet(style)

        style = f&quot;&quot;&quot;
        QFrame {{
        background-color: {os.environ.get(&#39;secondaryColor&#39;)}
        }}
        &quot;&quot;&quot;
        self.main.frame_3.setStyleSheet(style)
        self.main.frame_2.setStyleSheet(style)
        self.main.frame_5.setStyleSheet(style)
        self.main.frame_6.setStyleSheet(style)
        self.main.frame_7.setStyleSheet(style)
        self.main.frame_4.setStyleSheet(style)
        self.main.frame.setStyleSheet(style)

        style = &quot;&quot;&quot;
        *{
        color: black;
        }
        &quot;&quot;&quot;

        # FONTSIZE
        labels = [
            self.main.label_15,
            self.main.label_16,
            self.main.label_17,
            self.main.label_20,
            self.main.label_21,
            self.main.label_22,
            self.main.label_23,
        ]
        for label in labels:
            if json.loads(os.getenv(&#39;BCISTREAM_RASPAD&#39;)):
                label.setText(
                    label.text().replace(&#39;font-size:12pt&#39;, &#39;font-size:10pt&#39;)
                )

        with open(
            os.path.join(os.environ[&#39;BCISTREAM_ROOT&#39;], &#39;_version.txt&#39;), &#39;r&#39;
        ) as file:
            self.main.label_software_version.setText(
                f&#39;{file.read().strip()} {version} {mode}&#39;
            )</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.show_about"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.show_about">[docs]</a>    def show_about(self, *args, **wargs) -&gt; None:
        &quot;&quot;&quot;Display about window.&quot;&quot;&quot;
        frame = os.path.join(
            os.environ[&#39;BCISTREAM_ROOT&#39;], &#39;framework&#39;, &#39;qtgui&#39;, &#39;about.ui&#39;
        )
        about = QUiLoader().load(frame, self.main)
        about.label.setScaledContents(True)

        about.pushButton_close.clicked.connect(lambda evt: about.destroy())

        about.label.setMinimumSize(QSize(600, 200))
        about.label.setMaximumSize(QSize(600, 200))

        banner = os.path.join(
            os.environ[&#39;BCISTREAM_ROOT&#39;], &#39;assets&#39;, &#39;banner.png&#39;
        )
        about.label.setPixmap(QPixmap(banner))

        about.tabWidget.setCurrentIndex(0)

        about.setStyleSheet(
            f&quot;&quot;&quot;
        QPlainTextEdit {{
        font-weight: normal;
        font-family: &#39;DejaVu Sans Mono&#39;;
        font-size: 13px;
        }}

        QTextEdit {{
        color: {os.environ.get(&#39;QTMATERIAL_SECONDARYTEXTCOLOR&#39;)};
        }}
        &quot;&quot;&quot;
        )

        center = QWidget.screen(self).availableGeometry().center()
        geometry = about.frameGeometry()
        geometry.moveCenter(center)
        about.move(geometry.topLeft())

        about.show()</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.on_kafka_event"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.on_kafka_event">[docs]</a>    @Slot()
    def on_kafka_event(self, value: KafkaMessage) -&gt; None:
        &quot;&quot;&quot;Register annotations and markers.&quot;&quot;&quot;

        self.streaming = True

        if value[&#39;topic&#39;] == &#39;marker&#39;:
            self.annotations.add_marker(
                datetime.fromtimestamp(value[&#39;value&#39;][&#39;timestamp&#39;]),
                value[&#39;value&#39;][&#39;marker&#39;],
            )
        elif value[&#39;topic&#39;] == &#39;command&#39;:
            self.annotations.add_command(
                datetime.fromtimestamp(value[&#39;value&#39;][&#39;timestamp&#39;]),
                value[&#39;value&#39;][&#39;command&#39;],
            )
        elif value[&#39;topic&#39;] == &#39;annotation&#39;:
            self.annotations.add_annotation(
                datetime.fromtimestamp(value[&#39;value&#39;][&#39;timestamp&#39;]),
                value[&#39;value&#39;][&#39;duration&#39;],
                value[&#39;value&#39;][&#39;description&#39;],
            )
        elif value[&#39;topic&#39;] == &#39;feedback&#39;:
            self.handle_feedback(value[&#39;value&#39;])

        elif value[&#39;topic&#39;] in [&#39;eeg&#39;, &#39;aux&#39;]:

            if time.time() &lt; self.last_update + 1:
                return
            self.last_update = time.time()

            # Use only remote times to make the calculation, so the
            # differents clocks not affect the measure
            binary_created = datetime.fromtimestamp(
                min(value[&#39;value&#39;][&#39;context&#39;][&#39;timestamp.binary&#39;])
            )
            message_created = datetime.fromtimestamp(
                value[&#39;value&#39;][&#39;timestamp&#39;]
            )
            since = (message_created - binary_created).total_seconds()
            if value[&#39;topic&#39;] == &#39;eeg&#39;:
                self.eeg_size = value[&#39;value&#39;][&#39;data&#39;].shape
            elif value[&#39;topic&#39;] == &#39;aux&#39;:
                self.aux_size = value[&#39;value&#39;][&#39;data&#39;].shape

            if since * 1000 &gt; 2000:
                color = &#39;#ffc107&#39;  # old data
            else:
                color = &#39;#3fc55e&#39;  # recent data

            message = f&#39;Last package streamed &lt;b style=&quot;color:{color};&quot;&gt;{since*1000:0.2f} ms &lt;/b&gt; ago | EEG{self.eeg_size} | AUX{self.aux_size}&#39;

            if status := getattr(self.records, &#39;recording_status&#39;, None):
                message += f&#39; | &lt;b style=&quot;color:#dc3545;&quot;&gt;{status}&lt;/b&gt;&#39;

            self.status_bar(right_message=(message, True))</div>
            # self.last_update = value[&#39;value&#39;][&#39;timestamp&#39;]

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.update_kafka"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.update_kafka">[docs]</a>    def update_kafka(self, host: HostLike) -&gt; None:
        &quot;&quot;&quot;Try to restart kafka services.&quot;&quot;&quot;
        if hasattr(self, &#39;thread_kafka&#39;):
            self.thread_kafka.stop()
            self.status_bar(right_message=(&#39;No streaming&#39;, False))
        # try:
        self.thread_kafka = Kafka()
        self.thread_kafka.signal_kafka_message.connect(self.on_kafka_event)
        # self.thread_kafka.first_consume.connect(lambda: self.connection.on_connect(
        # True))
        self.thread_kafka.signal_exception_message.connect(
            self.kafka_message
        )
        self.thread_kafka.signal_produser.connect(
            self.kafka_produser_connected
        )
        self.thread_kafka.set_host(host)
        self.thread_kafka.start()

        self.timer = QTimer()
        self.timer.setInterval(1000)
        self.timer.timeout.connect(self.keep_updated)
        self.timer.start()</div>

    # ----------------------------------------------------------------------
    def calculate_offset(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        host = self.thread_kafka.host
        if host != &#39;localhost&#39;:
            self.offset_thread = ClockOffset()
            self.offset_thread.signal_offset.connect(self.set_offset)
            self.offset_thread.set_host(self.thread_kafka.host)
            self.offset_thread.start()
        else:
            self.set_offset(0)

    # ----------------------------------------------------------------------
    def set_offset(self, offset: Millis) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        os.environ[&#39;BCISTREAM_OFFSET&#39;] = json.dumps(offset)

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.stop_kafka"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.stop_kafka">[docs]</a>    def stop_kafka(self) -&gt; None:
        &quot;&quot;&quot;Stop kafka.&quot;&quot;&quot;
        self.streaming = False
        if hasattr(self, &#39;thread_kafka&#39;):
            self.thread_kafka.stop()
            self.status_bar(right_message=(&#39;No streaming&#39;, False))</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.keep_updated"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.keep_updated">[docs]</a>    def keep_updated(self) -&gt; None:
        &quot;&quot;&quot;The status is update each 3 seconds.&quot;&quot;&quot;
        if hasattr(self, &#39;thread_kafka&#39;) and hasattr(
            self.thread_kafka, &#39;last_message&#39;
        ):
            last = datetime.now() - self.thread_kafka.last_message
            if last.seconds &gt; 3:
                self.status_bar(right_message=(&#39;No streaming&#39;, False))
                self.annotations.set_enable(False)
                self.main.pushButton_record.setEnabled(False)
                self.streaming = False
            else:
                self.annotations.set_enable(True)
                self.main.pushButton_record.setEnabled(True)</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.kafka_message"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.kafka_message">[docs]</a>    @Slot()
    def kafka_message(self) -&gt; None:
        &quot;&quot;&quot;Error on kafka.&quot;&quot;&quot;
        self.streaming = False
        if self.main.comboBox_host.currentText() != &#39;localhost&#39;:
            self.conection_message = f&#39;* Imposible to connect with remote Kafka on &quot;{self.main.comboBox_host.currentText()}&quot;.&#39;
        else:
            self.conection_message = (
                &#39;* Kafka is not running on this machine.&#39;
            )

        self.status_bar(right_message=(&#39;Disconnected&#39;, None))</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.kafka_produser_connected"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.kafka_produser_connected">[docs]</a>    @Slot()
    def kafka_produser_connected(self) -&gt; None:
        &quot;&quot;&quot;If produser connected is posible the consumer too.&quot;&quot;&quot;
        self.status_bar(right_message=(&#39;Connected&#39;, False))</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="BCIFramework.show_configurations"><a class="viewcode-back" href="../../bci_framework.framework.core.html#bci_framework.framework.core.BCIFramework.show_configurations">[docs]</a>    def show_configurations(self, *args, **kwargs) -&gt; None:
        &quot;&quot;&quot;Show configuration window.&quot;&quot;&quot;
        configuration = ConfigurationFrame(self)
        configuration.show()</div>

    # ----------------------------------------------------------------------
    def handle_feedback(self, data) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        if fn := getattr(self, f&quot;feedback_{data.get(&#39;name&#39;, False)}&quot;, False):
            fn(data[&#39;value&#39;])
        if fn := getattr(self, f&quot;feedback_{data.get(&#39;command&#39;, False)}&quot;, False):
            fn(data[&#39;value&#39;])

    # ----------------------------------------------------------------------
    def feedback_set_latency(self, latency: Millis) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        os.environ[&#39;BCISTREAM_SYNCLATENCY&#39;] = json.dumps(latency)

    # ----------------------------------------------------------------------
    def start_stimuli_server(self) -&gt; None:
        &quot;&quot;&quot;&quot;&quot;&quot;
        if &#39;--local&#39; in sys.argv:
            self.bciframework_server = run_subprocess(
                [
                    sys.executable,
                    os.path.join(
                        os.environ[&#39;BCISTREAM_ROOT&#39;],
                        &#39;python_scripts&#39;,
                        &#39;bciframework_server&#39;,
                        &#39;main.py&#39;,
                    ),
                ]
            )
        else:
            self.bciframework_server = run_subprocess(
                [
                    sys.executable,
                    os.path.join(
                        os.environ[&#39;BCISTREAM_HOME&#39;],
                        &#39;python_scripts&#39;,
                        &#39;bciframework_server&#39;,
                        &#39;main.py&#39;,
                    ),
                ]
            )</div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/01-installation.html">Installation and running</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/02-interface.html">Interface description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/03-data_analysis.html">Data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/04-data_visualizations.html">Data visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/06-stimuli_delivery.html">Stimuli delivery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/07-neurofeedback.html">Neurofeedback</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/08-event_marker_synchronization.html">Event marker synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/09-ilustrative_example.html">Illustrative example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/10-paradigms.html">Paradigms</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021-2022, .
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>