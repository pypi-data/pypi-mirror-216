
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bci_framework.extensions.visualizations.eeg_stream &#8212; BCI-Framework  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favico.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bci_framework.extensions.visualizations.eeg_stream</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
==========
EEG Stream
==========

Reimplementation of `Matplotlib-FigureStream
&lt;https://figurestream.readthedocs.io/en/latest/&gt;`_ with some renames and a
preconfigured server.
&quot;&quot;&quot;

import os
import sys
import json
import pickle
import logging
import time

import mne
import numpy as np
import matplotlib
from matplotlib import pyplot
from cycler import cycler
from kafka import KafkaProducer
from figurestream import FigureStream
from typing import Optional, Tuple, Literal, Callable

from ...extensions import properties as prop
from ...extensions.data_analysis import DataAnalysis

# Consigure matplotlib
if (&#39;light&#39; in sys.argv) or (
    &#39;light&#39; in os.environ.get(&#39;QTMATERIAL_THEME&#39;, &#39;&#39;)
):
    pass
else:
    pyplot.style.use(&#39;dark_background&#39;)

try:
    q = matplotlib.cm.get_cmap(&#39;rainbow&#39;)
    matplotlib.rcParams[&#39;axes.prop_cycle&#39;] = cycler(
        color=[q(m) for m in np.linspace(0, 1, 16)]
    )
    matplotlib.rcParams[&#39;figure.dpi&#39;] = 70
    matplotlib.rcParams[&#39;font.family&#39;] = &#39;monospace&#39;
    matplotlib.rcParams[&#39;font.size&#39;] = 15
except:
    # &#39;rcParams&#39; object does not support item assignment
    pass

# Set logger
logger = logging.getLogger(&quot;mne&quot;)
logger.setLevel(logging.CRITICAL)
logging.root.name = &quot;Visualizations&quot;


########################################################################
<div class="viewcode-block" id="MNEObjects"><a class="viewcode-back" href="../../../bci_framework.extensions.visualizations.eeg_stream.html#bci_framework.extensions.visualizations.eeg_stream.MNEObjects">[docs]</a>class MNEObjects:
    &quot;&quot;&quot;Creat MNE handlers using the framework GUI information.&quot;&quot;&quot;

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="MNEObjects.get_mne_info"><a class="viewcode-back" href="../../../bci_framework.extensions.visualizations.eeg_stream.html#bci_framework.extensions.visualizations.eeg_stream.MNEObjects.get_mne_info">[docs]</a>    def get_mne_info(self) -&gt; mne.Info:
        &quot;&quot;&quot;Create the `Info` object to use with mne handlers.

        The information is acquired automatically from GUI interface.
        &quot;&quot;&quot;

        info = mne.create_info(
            list(prop.CHANNELS.values()),
            sfreq=prop.SAMPLE_RATE,
            ch_types=&quot;eeg&quot;,
        )
        info.set_montage(prop.MONTAGE_NAME)
        return info</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="MNEObjects.get_mne_montage"><a class="viewcode-back" href="../../../bci_framework.extensions.visualizations.eeg_stream.html#bci_framework.extensions.visualizations.eeg_stream.MNEObjects.get_mne_montage">[docs]</a>    def get_mne_montage(self) -&gt; mne.channels.DigMontage:
        &quot;&quot;&quot;Create the `Montage` object to use with mne handlers.

        The information is acquired automatically from GUI interface.
        &quot;&quot;&quot;

        montage = mne.channels.make_standard_montage(prop.MONTAGE_NAME)
        return montage</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="MNEObjects.get_mne_evoked"><a class="viewcode-back" href="../../../bci_framework.extensions.visualizations.eeg_stream.html#bci_framework.extensions.visualizations.eeg_stream.MNEObjects.get_mne_evoked">[docs]</a>    def get_mne_evoked(self) -&gt; mne.EvokedArray:
        &quot;&quot;&quot;Create the `Evoked` object to use with mne handlers.

        The information is acquired automatically from GUI interface.
        &quot;&quot;&quot;

        comment = &quot;bcistream&quot;
        evoked = mne.EvokedArray(
            lf.buffer_eeg_, self.get_mne_info(), 0, comment=comment, nave=0
        )
        return evoked</div></div>


########################################################################
<div class="viewcode-block" id="EEGStream"><a class="viewcode-back" href="../../../bci_framework.extensions.visualizations.eeg_stream.html#bci_framework.extensions.visualizations.eeg_stream.EEGStream">[docs]</a>class EEGStream(FigureStream, DataAnalysis, MNEObjects):
    &quot;&quot;&quot;Matplotlib figure re-implementation.

    This class define some usefull methods to use for simplificate the data
    manipulation.
    &quot;&quot;&quot;

    # ----------------------------------------------------------------------
    def __init__(self, enable_produser=False, *args, **kwargs):
        &quot;&quot;&quot;&quot;&quot;&quot;
        port = 5000
        super().__init__(
            host=&#39;0.0.0.0&#39;, port=port, endpoint=&#39;&#39;, *args, **kwargs
        )

        # self._pivot = None
        if enable_produser:
            self._enable_commands()

        self._feedback = False
        self._package_size = None

        self.transformers_ = {}
        self.transformers_aux_ = {}
        self.widget_value = {}
        self.wait_for_interact()

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="EEGStream.create_lines"><a class="viewcode-back" href="../../../bci_framework.extensions.visualizations.eeg_stream.html#bci_framework.extensions.visualizations.eeg_stream.EEGStream.create_lines">[docs]</a>    def create_lines(
        self,
        mode: Literal[&#39;eeg&#39;, &#39;accel&#39;, &#39;analog&#39;, &#39;digital&#39;] = &#39;eeg&#39;,
        time: Optional[int] = -15,
        window: Optional[int] = 1000,
        cmap: Optional[str] = &#39;cool&#39;,
        fill: Optional[np.ndarray] = np.nan,
        subplot: Optional[list] = [1, 1, 1],
    ) -&gt; Tuple[matplotlib.axes.Axes, np.ndarray, list[matplotlib.lines]]:
        &quot;&quot;&quot;Create plot automatically.

        Create and configure a subplot to display figures.

        Parameters
        ----------
        mode
            Used for select the axis labels.
        time
            The time window, can be negative.
        window
            The number of samples used to draw the figure.
        cmap
            The matplolib `cmap` to use.
        fill
            Start signals array with this value.
        subplot
            The matplolib subplot.

        Returns
        -------
        axis
            The subplot created.
        time
            The time array.
        lines
            The matplotlib `lines` object created for each channel.
        &quot;&quot;&quot;

        mode = mode.lower()
        sr = prop.SAMPLE_RATE

        if mode == &#39;eeg&#39;:
            channels = len(prop.CHANNELS)
            labels = None
            ylim = 0, 16
        elif mode == &#39;accel&#39; or mode == &#39;default&#39; or mode == &#39;aux&#39;:
            channels = 3
            labels = [&#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;]
            ylim = -6, 6
            sr = sr / 10
        elif mode == &#39;analog&#39; and not prop.CONNECTION == &#39;wifi&#39;:
            channels = 3
            labels = [&#39;A5(D11)&#39;, &#39;A6(D12)&#39;, &#39;A7(D13)&#39;]
            ylim = 0, 2**10
        elif mode == &#39;analog&#39; and prop.CONNECTION == &#39;wifi&#39;:
            channels = 2
            labels = [&#39;A5(D11)&#39;, &#39;A6(D12)&#39;]
            ylim = 0, 2**10
        elif mode == &#39;digital&#39; and not prop.CONNECTION == &#39;wifi&#39;:
            channels = 5
            labels = [&#39;D11&#39;, &#39;D12&#39;, &#39;D13&#39;, &#39;D17&#39;, &#39;D18&#39;]
            ylim = 0, 1.2
        elif mode == &#39;digital&#39; and prop.CONNECTION == &#39;wifi&#39;:
            channels = 3
            labels = [&#39;D11&#39;, &#39;D12&#39;, &#39;D17&#39;]
            ylim = 0, 1.2

        q = matplotlib.cm.get_cmap(cmap)
        matplotlib.rcParams[&#39;axes.prop_cycle&#39;] = cycler(
            color=[q(m) for m in np.linspace(0, 1, channels)]
        )

        axis = self.add_subplot(*subplot)

        window = self._get_factor_near_to(
            prop.SAMPLE_RATE * np.abs(time), n=window
        )
        # self._create_resampled_buffer(
        # prop.SAMPLE_RATE * np.abs(time), n=1000)

        a = np.empty(window)
        a.fill(fill)

        lines = [
            axis.plot(
                a.copy(),
                a.copy(),
                &#39;-&#39;,
                label=(labels[i] if labels else None),
            )[0]
            for i in range(channels)
        ]

        if labels:
            axis.legend()

        if time &gt; 0:
            axis.set_xlim(0, time)
            time = np.linspace(0, time, window)
        else:
            axis.set_xlim(time, 0)
            time = np.linspace(time, 0, window)
        axis.set_ylim(*ylim)

        # if mode != &#39;eeg&#39;:
        # axis.legend()

        axis.grid(
            True,
            color=os.environ.get(
                &#39;QTMATERIAL_SECONDARYLIGHTCOLOR&#39;, &#39;#ff0000&#39;
            ),
            zorder=0,
        )
        lines = np.array(lines)

        return axis, time, lines</div>

    # # ----------------------------------------------------------------------
    # def reverse_buffer(self, axis: matplotlib.axes.Axes, min: Optional[int] = 0, max: Optional[int] = 17, color: Optional[str] = &#39;k&#39;):
    # &quot;&quot;&quot;Add the boundary line to some visualizations.&quot;&quot;&quot;

    # if hasattr(self, &#39;boundary_line&#39;):
    # self.boundary_line.remove()
    # start = self._pivot / prop.SAMPLE_RATE
    # else:
    # self._pivot = 0
    # self._pivot_aux = 0
    # start = 0

    # self.boundary_line = axis.vlines(
    # start, min, max, color=color, zorder=99)

    # # ----------------------------------------------------------------------
    # def plot_pivot(self):
    # &quot;&quot;&quot;Update the position of the boundary line.&quot;&quot;&quot;

    # if hasattr(self, &#39;boundary_line&#39;):
    # segments = self.boundary_line.get_segments()
    # segments[0][:, 0] = [self._pivot / prop.SAMPLE_RATE,
    # self._pivot / prop.SAMPLE_RATE]
    # self.boundary_line.set_segments(segments)

    # else:
    # logging.warning(&#39;No &quot;boundary&quot; to plot&#39;)

    # # ----------------------------------------------------------------------
    # def feed(self):
    # &quot;&quot;&quot;&quot;&quot;&quot;
    # super().feed()

    # ----------------------------------------------------------------------
    def wait_for_interact(self):
        &quot;&quot;&quot;&quot;&quot;&quot;
        if os.path.exists(os.path.join(sys.path[0], &#39;interact&#39;)):
            with open(os.path.join(sys.path[0], &#39;interact&#39;), &#39;r&#39;) as file:
                for line in file.readlines():
                    l = json.loads(line)
                    if l[0] == &#39;#&#39;:
                        ll, v = l[1], l[4]
                    else:
                        ll, v = l[0], l[3]
                    self.widget_value[ll] = v</div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/logo.svg" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/01-installation.html">Installation and running</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/02-interface.html">Interface description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/03-data_analysis.html">Data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/04-data_visualizations.html">Data visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/06-stimuli_delivery.html">Stimuli delivery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/07-neurofeedback.html">Neurofeedback</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/08-event_marker_synchronization.html">Event marker synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/09-ilustrative_example.html">Illustrative example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/10-paradigms.html">Paradigms</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021-2022, .
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>