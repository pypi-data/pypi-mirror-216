
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bci_framework.extensions.stimuli_delivery.tornado_handlers &#8212; BCI-Framework  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favico.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bci_framework.extensions.stimuli_delivery.tornado_handlers</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
================
Tornado Handlers
================

This handlers are used to configure the `Stimuli Delivery`.
&quot;&quot;&quot;

import json
import pickle
import logging
from queue import Queue
from typing import TypeVar
import asyncio

from tornado import gen
from tornado.ioloop import IOLoop
from tornado.web import RequestHandler
from tornado.websocket import WebSocketHandler, WebSocketClosedError
from kafka import KafkaProducer, KafkaConsumer

from datetime import datetime, timedelta
from bci_framework.extensions import properties as prop
from bci_framework.extensions.data_analysis.utils import thread_this, subprocess_this

created_consumer = [False]
clients = {}
JSON = TypeVar(&#39;json&#39;)

logging.getLogger(&#39;kafka&#39;).setLevel(logging.CRITICAL)
logging.getLogger(&#39;kafka.conn&#39;).setLevel(logging.CRITICAL)


# ----------------------------------------------------------------------
@thread_this
def bci_consumer():
    &quot;&quot;&quot;&quot;&quot;&quot;
    asyncio.set_event_loop(asyncio.new_event_loop())

    try:
        consumer = KafkaConsumer(
            bootstrap_servers=[f&#39;{prop.HOST}:9092&#39;],
            value_deserializer=pickle.loads,
            auto_offset_reset=&#39;latest&#39;,
        )
    except:
        return

    consumer.subscribe([&#39;feedback&#39;])
    count = 0
    for message in consumer:
        count += 1
        for client in clients:
            try:
                clients[client].write_message(json.dumps({&#39;method&#39;: &#39;_on_feedback&#39;,
                                                          &#39;args&#39;: [],
                                                          &#39;kwargs&#39;: {**message.value, **{&#39;c&#39;: count, }},
                                                          }))
            except:
                pass


bci_consumer()


########################################################################
<div class="viewcode-block" id="ModeHandler"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.ModeHandler">[docs]</a>class ModeHandler(RequestHandler):
    &quot;&quot;&quot;`/mode` endpoint to differentiate between `Data analysis` and `Stimuli Delivery`.&quot;&quot;&quot;

<div class="viewcode-block" id="ModeHandler.set_default_headers"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.ModeHandler.set_default_headers">[docs]</a>    def set_default_headers(self):
        self.set_header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;)
        self.set_header(&quot;Access-Control-Allow-Headers&quot;, &quot;x-requested-with&quot;)
        self.set_header(&quot;Access-Control-Allow-Methods&quot;, &quot;POST, GET, OPTIONS&quot;)
        self.set_header(&quot;Access-Control-Allow-Headers&quot;,
                        &quot;access-control-allow-origin,authorization,content-type&quot;)</div>

    # ----------------------------------------------------------------------
    def get(self):
        self.write(&#39;stimuli&#39;)</div>


########################################################################
<div class="viewcode-block" id="WSHandler"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.WSHandler">[docs]</a>class WSHandler(WebSocketHandler):
    &quot;&quot;&quot;WebSockets is the way to comunicate between dashboard and presentations.&quot;&quot;&quot;

    # ----------------------------------------------------------------------
    def __init__(self, *args, **kwargs):
        &quot;&quot;&quot;&quot;&quot;&quot;
        super().__init__(*args, **kwargs)

        try:
            self.kafka_producer = KafkaProducer(
                bootstrap_servers=[f&#39;{prop.HOST}:9092&#39;],
                compression_type=&#39;gzip&#39;,
                value_serializer=pickle.dumps,
            )
        except:
            logging.warning(
                f&#39;Kafka host ({prop.HOST}:9092) not available!&#39;)

        # self.bci_consumer()

    # ----------------------------------------------------------------------
    def check_origin(self, *args, **kwargs):
        &quot;&quot;&quot;&quot;&quot;&quot;
        return True

    # ----------------------------------------------------------------------
    def open(self):
        &quot;&quot;&quot;&quot;&quot;&quot;
        self.print_log(&#39;tornado_ok&#39;)

    # # ----------------------------------------------------------------------
    # def on_close(self):
        # &quot;&quot;&quot;&quot;&quot;&quot;
        # if self in clients:
            # clients.pop(clients.index(self))
        # super().on_close(self)

    # # ----------------------------------------------------------------------
    # def on_connection_close(self):
        # &quot;&quot;&quot;&quot;&quot;&quot;
        # if self in clients:
            # clients.pop(clients.index(self))
        # super().on_connection_close(self)

    # ----------------------------------------------------------------------
    def print_log(self, message: str):
        &quot;&quot;&quot;&quot;&quot;&quot;
        try:
            self.write_message({&#39;log&#39;: message})
        except Exception as error:
            print(message)
            print(error)
            try:
                self.write_message({&#39;log&#39;: error})
            except:
                pass

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="WSHandler.on_message"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.WSHandler.on_message">[docs]</a>    def on_message(self, message: JSON):
        &quot;&quot;&quot;Input messages are methods reference with arguments.

        The callable are defined with a `bci_` prefix in the methods names.

        Parameters
        ----------
        message
            json string with method name and key words arguments.
        &quot;&quot;&quot;
        if message:
            data = json.loads(message)

            # if data[&#39;action&#39;] == &#39;consumer&#39; and not created_consumer[0]:
                # created_consumer = [True]
                # # bci_consumer()
                # # return
            # elif data[&#39;action&#39;] == &#39;consumer&#39; and created_consumer[0]:
                # return

            getattr(self, f&#39;bci_{data[&quot;action&quot;]}&#39;)(**data)</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="WSHandler.bci_register"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.WSHandler.bci_register">[docs]</a>    def bci_register(self, **kwargs):
        &quot;&quot;&quot;Register clients.&quot;&quot;&quot;

        clients[kwargs[&#39;mode&#39;]] = self</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="WSHandler.bci_feed"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.WSHandler.bci_feed">[docs]</a>    def bci_feed(self, **kwargs):
        &quot;&quot;&quot;Call the same method in all clients.&quot;&quot;&quot;
        # for i, client in enumerate(clients):
            # if client != self:
                # try:
                    # client.write_message(kwargs)
                # except WebSocketClosedError:
                    # clients.pop(i)
        for client in clients:
            if clients[client] != self:
                try:
                    clients[client].write_message(kwargs)
                except:
                    pass</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="WSHandler.bci_marker"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.WSHandler.bci_marker">[docs]</a>    def bci_marker(self, **kwargs):
        &quot;&quot;&quot;Use kafka to stream markers.&quot;&quot;&quot;

        marker = kwargs[&#39;marker&#39;]
        marker[&#39;datetime&#39;] = (
            datetime.now() - timedelta(milliseconds=marker[&#39;latency&#39;] + prop.SYNCLATENCY)).timestamp()
        # marker[&#39;datetime&#39;] = datetime.now().timestamp()
        logging.warning(f&#39;Latency: XXXXX&#39;)
        logging.warning(f&#39;Latency: {prop.SYNCLATENCY}&#39;)
        logging.warning(f&#39;Latency: {marker[&quot;latency&quot;]}&#39;)
        logging.warning(f&#39;Latency: XXXXX&#39;)
        del marker[&#39;latency&#39;]

        if hasattr(self, &#39;kafka_producer&#39;):
            self.kafka_producer.send(&#39;marker&#39;, marker)
        else:
            print(&quot;No Kafka produser available!&quot;)</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="WSHandler.bci_annotation"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.WSHandler.bci_annotation">[docs]</a>    def bci_annotation(self, **kwargs):
        &quot;&quot;&quot;Use kafka to stream annotations.&quot;&quot;&quot;

        annotation = kwargs[&#39;annotation&#39;]
        annotation[&#39;onset&#39;] = (
            datetime.now() - timedelta(milliseconds=annotation[&#39;latency&#39;] + prop.SYNCLATENCY)).timestamp()
        del annotation[&#39;latency&#39;]

        if hasattr(self, &#39;kafka_producer&#39;):
            self.kafka_producer.send(&#39;annotation&#39;, annotation)
        else:
            print(&quot;No Kafka produser available!&quot;)</div>

    # ----------------------------------------------------------------------
<div class="viewcode-block" id="WSHandler.bci_feedback"><a class="viewcode-back" href="../../../bci_framework.extensions.stimuli_delivery.tornado_handlers.html#bci_framework.extensions.stimuli_delivery.tornado_handlers.WSHandler.bci_feedback">[docs]</a>    def bci_feedback(self, **kwargs):
        &quot;&quot;&quot;Use kafka to stream annotations.&quot;&quot;&quot;

        feedback = kwargs[&#39;feedback&#39;]

        if hasattr(self, &#39;kafka_producer&#39;):
            self.kafka_producer.send(&#39;feedback&#39;, feedback)
        else:
            print(&quot;No Kafka produser available!&quot;)</div></div>

    # # ----------------------------------------------------------------------
    # @thread_this
    # def bci_consumer(cls, **kwargs):
        # &quot;&quot;&quot;&quot;&quot;&quot;
        # asyncio.set_event_loop(asyncio.new_event_loop())

        # try:
            # consumer = KafkaConsumer(
                # bootstrap_servers=[f&#39;{prop.HOST}:9092&#39;],
                # value_deserializer=pickle.loads,
                # auto_offset_reset=&#39;latest&#39;,
            # )
        # except:
            # return

        # consumer.subscribe([&#39;feedback&#39;])
        # count = 0
        # for message in consumer:
            # for client in clients:
                # if cls != clients[client]:
                    # try:
                        # count += 1
                        # clients[client].write_message(json.dumps({&#39;method&#39;: &#39;_on_feedback&#39;,
                                                                  # &#39;args&#39;: [],
                                                                  # &#39;kwargs&#39;: {**message.value, **{&#39;c&#39;: count, }},
                                                                  # }))
                    # except:
                        # pass
                    # # clients.pop(i)


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/logo.svg" alt="Logo"/>
            </a></p><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/01-installation.html">Installation and running</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/02-interface.html">Interface description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/03-data_analysis.html">Data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/04-data_visualizations.html">Data visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/06-stimuli_delivery.html">Stimuli delivery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/07-neurofeedback.html">Neurofeedback</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/08-event_marker_synchronization.html">Event marker synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/09-ilustrative_example.html">Illustrative example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/10-paradigms.html">Paradigms</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021-2022, .
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>